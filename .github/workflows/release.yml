name: Create Release Package

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Create release directory
        run: |
          mkdir -p release/pisco-code-${{ steps.get_version.outputs.VERSION }}
          
      - name: Copy library files only
        run: |
          cp -r include/ release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          cp -r src/ release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          cp CMakeLists.txt release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          cp README.md release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          cp INTEGRATION.md release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          cp LICENSE release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          
      - name: Verify release package structure
        run: |
          echo "=== Release Package Contents ==="
          ls -la release/pisco-code-${{ steps.get_version.outputs.VERSION }}/
          echo "=== Source Files ==="
          ls -la release/pisco-code-${{ steps.get_version.outputs.VERSION }}/src/
          echo "=== Freestanding Shims ==="
          ls -la release/pisco-code-${{ steps.get_version.outputs.VERSION }}/src/freestanding/
          echo "=== Header Files ==="
          ls -la release/pisco-code-${{ steps.get_version.outputs.VERSION }}/include/
          
      - name: Create archives
        run: |
          cd release
          tar -czf pisco-code-${{ steps.get_version.outputs.VERSION }}.tar.gz pisco-code-${{ steps.get_version.outputs.VERSION }}/
          zip -r pisco-code-${{ steps.get_version.outputs.VERSION }}.zip pisco-code-${{ steps.get_version.outputs.VERSION }}/
          
      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz *.zip > checksums.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/pisco-code-${{ steps.get_version.outputs.VERSION }}.tar.gz
            release/pisco-code-${{ steps.get_version.outputs.VERSION }}.zip
            release/checksums.txt
          body: |
            # Pisco Code Library ${{ steps.get_version.outputs.VERSION }}
            
            ## Library-Only Distribution
            
            This release contains only the library files needed for integration:
            - `include/` - Header files
            - `src/` - Implementation files  
            - `CMakeLists.txt` - Library build configuration
            - `README.md` - Usage documentation
            - `LICENSE` - License information
            
            ## Integration Methods
            
            ### Method 1: Download and Extract (Offline-Friendly)
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/pisco-code-${{ steps.get_version.outputs.VERSION }}.tar.gz
            tar -xzf pisco-code-${{ steps.get_version.outputs.VERSION }}.tar.gz -C libs/
            ```
            
            CMakeLists.txt:
            ```cmake
            add_subdirectory(libs/pisco-code-${{ steps.get_version.outputs.VERSION }})
            target_link_libraries(your_project PRIVATE PiscoCodeCore)
            # Or for bare-metal/freestanding: target_link_libraries(your_project PRIVATE PiscoCodeCoreBare)
            ```
            
            ### Method 2: CMake FetchContent (Automatic Download)
            ```cmake
            include(FetchContent)
            FetchContent_Declare(
              pisco_code
              URL https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/pisco-code-${{ steps.get_version.outputs.VERSION }}.tar.gz
            )
            FetchContent_MakeAvailable(pisco_code)
            
            target_link_libraries(your_project PRIVATE PiscoCodeCore)
            ```
            
            ### Method 3: Git Submodule
            ```bash
            git submodule add https://github.com/${{ github.repository }}.git libs/pisco-code
            git submodule update --init
            ```
            
            CMakeLists.txt:
            ```cmake
            add_subdirectory(libs/pisco-code)
            target_link_libraries(your_project PRIVATE PiscoCodeCore)
            ```
            
            ## Checksums
            Verify your download with the provided checksums.txt file.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s")
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # ... files section same as above
          body: |
            # Pisco Code Library ${{ steps.get_version.outputs.VERSION }}
            
            ## Changes
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## Library-Only Distribution
            # ... rest same as above